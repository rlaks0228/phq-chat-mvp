<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>청소년 마음도움</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- CSV 파서 (브라우저에서 바로 CSV 읽기) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    .bubble{border-radius:12px;padding:10px 12px;margin:6px 0;max-width:80%;}
    .me{background:#e8f0ff;align-self:flex-end;}
    .bot{background:#f5f5f5;align-self:flex-start;}
    .phq-card{border:1px solid #ddd;border-radius:12px;padding:12px;margin:10px 0;background:#fff;}
    .chat-area{display:flex;flex-direction:column;height:520px;overflow-y:auto;background:white;padding:12px;border:1px solid #e5e7eb;border-radius:10px;}
    a.link{color:#1d4ed8;text-decoration:underline;}
  </style>
</head>
<body class="bg-gray-50">
  <div class="max-w-6xl mx-auto p-4">
    <h1 class="text-2xl font-bold mb-1">청소년 마음도움</h1>
    <p class="text-sm text-gray-600 mb-4">
      이 서비스는 <b>선별(Screening)</b>과 <b>연결</b>을 돕기 위한 도구입니다. 진단이나 치료가 아닙니다.
    </p>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-2">
      <!-- 좌: PHQ-9 -->
      <div>
        <div class="phq-card">
          <div class="flex justify-between items-center">
            <h2 class="font-semibold text-lg">PHQ-9 우울 자가검사</h2>
            <button id="startBtn" class="px-3 py-1 bg-blue-600 text-white rounded">검사 시작</button>
          </div>

          <div id="phqPanel" class="mt-3 hidden">
            <div id="qBox" class="mb-3 text-sm"></div>
            <div class="flex gap-2">
              <button id="prevBtn" class="px-3 py-1 bg-gray-200 rounded">이전</button>
              <button id="nextBtn" class="px-3 py-1 bg-blue-600 text-white rounded">다음</button>
            </div>
          </div>

          <div id="resultBox" class="mt-4 text-sm"></div>
          <div id="centersBox" class="mt-4 text-sm"></div>
        </div>
      </div>

      <!-- 우: 대화형 지원(항상 시연 모드) -->
      <div>
        <div class="phq-card flex flex-col">
          <h2 class="font-semibold text-lg mb-2">대화형 지원</h2>
          <div id="chatArea" class="chat-area">
            <div class="bubble bot">
              안녕, 여긴 마음도움 챗이야. 힘든 마음을 들려줘도 괜찮아.<br/>
              위기라면 <b>1577-0199 또는 119</b>에 지금 바로 연락해줘.
            </div>
          </div>
          <div class="mt-2 flex gap-2">
            <input id="chatInput" class="flex-1 border rounded px-2 py-2" placeholder="메시지를 입력하세요" />
            <button id="sendBtn" class="px-3 py-2 bg-blue-600 text-white rounded">전송</button>
          </div>
        </div>
      </div>
    </div>

    <p class="text-xs text-gray-500 mt-6">
      ※ 응답 내용은 저장되지 않으며, 이 도구는 교육용/시연용 프로토타입입니다. 위기 시 즉시 <b>1577-0199 또는 119</b>로 연락하세요.
    </p>
  </div>

  <script>
    /* ======================== 공통 ======================== */
    function pushBubble(text, who='bot'){
      const chatArea=document.getElementById('chatArea');
      const div=document.createElement('div');
      div.className=`bubble ${who}`;
      div.innerHTML=(''+text).replace(/\n/g,'<br/>');
      chatArea.appendChild(div);
      chatArea.scrollTop=chatArea.scrollHeight;
    }

    /* ======================== 챗봇 (시연 고정) ======================== */
    const SCRIPT=[
      "안녕, 여긴 마음도움 챗이야. 오늘 하루 어땠어?",
      "음, 쉽지 않았겠다. 이렇게 말해줘서 정말 고마워.",
      "요즘 가장 힘들었던 순간이 언제였는지 하나만 떠올려볼래?",
      "그때 너의 몸이나 마음에서 어떤 신호가 있었는지도 같이 적어보자.",
      "잠깐, 호흡을 같이 맞춰볼까? 4초 들이마시고, 4초 멈추고, 6초 내쉬기 × 3회.",
      "만약 마음이 너무 벅차면 바로 도움을 받는 게 중요해. 1577-0199(정신건강 상담전화) 또는 119를 기억해줘.",
      "가까운 상담센터나 보건소에 연결하면 더 체계적으로 도울 수 있어.",
      "오늘 너를 버티게 해준 작은 것 하나만 적어볼래? (사람, 음악, 장소, 루틴 무엇이든 좋아)",
      "앞으로 24시간 동안 스스로에게 해줄 수 있는 아주 작은 행동 하나를 정해보자. (물 한 컵, 10분 산책 같은 것)",
      "네가 혼자가 아니라는 걸 꼭 기억해줘. 필요하면 언제든 다시 말 걸어줘.",
      "이 대화는 선별/지지 목적이야. 진단이나 치료가 필요하면 전문가와 꼭 상의하자.",
      "(다시 처음으로 돌아갈게!) 요즘 가장 힘들었던 순간이 언제였는지 하나만 떠올려볼래?"
    ];
    let scriptIdx=0;

    const sendBtn=document.getElementById('sendBtn');
    const chatInput=document.getElementById('chatInput');

    sendBtn.onclick=()=>{
      const msg=chatInput.value.trim();
      if(!msg) return;
      pushBubble(msg,'me');
      chatInput.value='';
      const line=SCRIPT[scriptIdx]||"(끝)";
      pushBubble(line,'bot');
      scriptIdx=(scriptIdx+1)%SCRIPT.length;
    };
    chatInput.addEventListener('keydown',e=>{if(e.key==='Enter')sendBtn.click();});

    /* ======================== PHQ-9 (클라이언트 해석) ======================== */
    const PHQ=[
      "일(공부)에 흥미나 즐거움이 거의 없다",
      "기분이 가라앉거나, 우울하거나, 희망이 없다",
      "잠들기 어렵거나 자주 깨거나 너무 많이 잔다",
      "피곤하다고 느끼거나 기운이 거의 없다",
      "입맛이 없거나 과식한다",
      "자신을 나쁘게 보거나 실패자라고 느낀다",
      "일(공부)에 집중하기가 어렵다",
      "남들이 알아챌 만큼 너무 느리게 움직이거나 말한다, 혹은 너무 초조해서 가만히 있지 못한다",
      "차라리 죽는 것이 낫겠다는 생각을 하거나, 자신을 해칠 생각을 했다"
    ];
    const CHOICES=["전혀 아니다(0)","몇 일 동안(1)","일주일 이상(2)","거의 매일(3)"];

    let idx=0, answers=Array(9).fill(null), userLat=null, userLng=null;

    const startBtn=document.getElementById('startBtn');
    const phqPanel=document.getElementById('phqPanel');
    const qBox=document.getElementById('qBox');
    const prevBtn=document.getElementById('prevBtn');
    const nextBtn=document.getElementById('nextBtn');
    const resultBox=document.getElementById('resultBox');
    const centersBox=document.getElementById('centersBox');

    // CSV 메모리
    let CENTER_ROWS = []; // {name,address,phone,lat,lng}

    // CSV 로드 (public/data/centers.csv)
    async function loadCentersCsv(){
      try{
        const res = await fetch('/data/centers.csv', {cache:'no-store'});
        if(!res.ok) return [];
        const text = await res.text();
        return new Promise((resolve)=>{
          Papa.parse(text, {
            header:true,
            skipEmptyLines:true,
            dynamicTyping:true,
            complete: (out)=>{
              // 매핑: 다양한 한글/영문 헤더를 공통키로 변환
              const norm = (k)=> (k||"").toString().trim().toLowerCase();
              const rows = out.data.map(row=>{
                // 원본 헤더를 소문자 비교
                const mapKey = {};
                for(const k in row){ mapKey[norm(k)] = k; }

                const name = row[ mapKey["기관명"] || mapKey["name"] ] || "";
                const address = row[ mapKey["주소"] || mapKey["address"] ] || "";
                const phone = row[ mapKey["전화번호"] || mapKey["phone"] ] || "";
                const lat = Number(row[ mapKey["위도"] || mapKey["lat"] || mapKey["latitude"] ]);
                const lng = Number(row[ mapKey["경도"] || mapKey["lng"] || mapKey["longitude"] ]);

                return { name: String(name||"").trim(),
                         address: String(address||"").trim(),
                         phone: String(phone||"").trim(),
                         lat: isFinite(lat)? lat: NaN,
                         lng: isFinite(lng)? lng: NaN };
              }).filter(r=>r.name || r.address);
              resolve(rows);
            }
          });
        });
      }catch{
        return [];
      }
    }

    function haversine(lat1, lon1, lat2, lon2){
      const toRad = (d)=> d*Math.PI/180;
      const R = 6371; // km
      const dLat = toRad(lat2-lat1);
      const dLon = toRad(lon2-lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(a));
    }

    function severityLabel(total){
      if(total<=4) return "없음/최소";
      if(total<=9) return "경도";
      if(total<=14) return "중등도";
      if(total<=19) return "중등도-중증";
      return "중증";
    }

    function supportiveText(total, sev, crisis){
      if(crisis){
        return "[고위험] 지금 매우 위급할 수 있어요. 즉시 1577-0199 또는 119에 연락하세요.";
      }
      if(sev==="없음/최소") return "현재 점수는 낮은 편이에요. 그래도 힘들면 주변의 믿을 만한 어른이나 친구와 이야기를 나눠 보세요.";
      if(sev==="경도") return "가벼운 우울감이 감지돼요. 잠, 식사, 가벼운 운동 같은 일상 리듬을 챙겨 보세요.";
      if(sev==="중등도") return "중등도 수준의 우울감이 보여요. 학교 상담실, 지역 정신건강복지센터 상담을 권해요.";
      if(sev==="중등도-중증") return "우울감이 뚜렷합니다. 가까운 상담기관에 빠르게 연결하는 것을 권해요.";
      return "점수가 높은 편이에요. 가능한 빠르게 전문 상담/진료를 받아 보세요.";
    }

    async function recommendCenters(lat, lng, topN=6){
      if(!CENTER_ROWS.length){
        CENTER_ROWS = await loadCentersCsv();
      }
      let arr = CENTER_ROWS.filter(r=> isFinite(r.lat) && isFinite(r.lng));
      if(!arr.length){
        return `<li>센터 데이터가 없거나 좌표가 비어 있습니다. 관리자에게 문의해 주세요.</li>`;
      }
      if(isFinite(lat) && isFinite(lng)){
        arr = arr.map(r=> ({...r, d: haversine(lat,lng,r.lat,r.lng)}))
                 .sort((a,b)=>(a.d||1e9)-(b.d||1e9));
      }
      const sel = arr.slice(0, topN);
      return sel.map(c=>{
        const q = encodeURIComponent(c.address || c.name);
        const km = isFinite(c.d) ? ` • 약 ${c.d.toFixed(1)} km` : "";
        const tel = c.phone ? ` | 📞 ${c.phone}` : "";
        return `<li class="mb-2">
          <div><b>${c.name || "(기관명 없음)"}</b>${km}</div>
          <div>${c.address || ""}${tel}</div>
          <div><a class="link" target="_blank" href="https://map.kakao.com/?q=${q}">지도 열기</a></div>
        </li>`;
      }).join("");
    }

    startBtn.onclick=async ()=>{
      idx=0; answers=Array(9).fill(null);
      phqPanel.classList.remove('hidden');
      resultBox.innerHTML=''; centersBox.innerHTML='';
      CENTER_ROWS = await loadCentersCsv(); // 미리 로드
      renderQ();

      // 위치 권한 (거부해도 동작: 거리 정렬 없이 상위 리스트만)
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(
          (p)=>{ userLat=p.coords.latitude; userLng=p.coords.longitude; },
          ()=>{}, { enableHighAccuracy:false, timeout:5000, maximumAge:0 }
        );
      }
    };

    function renderQ(){
      const a=answers[idx];
      qBox.innerHTML=`
        <div class="mb-2"><b>${idx+1}. ${PHQ[idx]}</b></div>
        <div class="space-y-1">
          ${CHOICES.map((t,i)=>`
            <label class="flex items-center gap-2">
              <input type="radio" name="ans" value="${i}" ${a===i?'checked':''}/>
              <span>${t}</span>
            </label>`).join('')}
        </div>`;
    }
    prevBtn.onclick=()=>{ if(idx>0){ idx--; renderQ(); } };
    nextBtn.onclick=async ()=>{
      const sel=document.querySelector('input[name="ans"]:checked');
      if(!sel){ alert('하나를 선택해 주세요'); return; }
      answers[idx]=Number(sel.value);
      if(idx<8){ idx++; renderQ(); return; }

      // 로컬 해석 + 근처 센터 추천
      phqPanel.classList.add('hidden');
      const total=answers.reduce((a,b)=>a+(Number(b)||0),0);
      const sev=severityLabel(total);
      const crisis=(Number(answers[8])||0) >= 1;

      const sup=supportiveText(total, sev, crisis);
      const crisisHtml = crisis
        ? `<div class="text-red-600 font-semibold mb-2">${sup}</div>`
        : `<div class="mb-2">${sup}</div>`;

      resultBox.innerHTML = `
        ${crisisHtml}
        <div>총점: <b>${total}</b> / 중증도: <b>${sev}</b></div>
        <div class="text-xs text-gray-600 mt-2">이 도구는 선별용이며 진단/치료가 아닙니다.</div>
      `;

      centersBox.innerHTML = `<div class="text-gray-500">가까운 센터를 찾는 중...</div>`;
      const listHtml = await recommendCenters(userLat, userLng, 8);
      centersBox.innerHTML = `
        <h3 class="font-semibold mt-4 mb-2">가까운 상담 도움</h3>
        <ul>${listHtml}</ul>
        <div class="mt-2 text-sm">또는 즉시 <b>1577-0199</b> (정신건강상담전화)에 연락하세요.</div>
      `;
    };
  </script>
</body>
</html>
