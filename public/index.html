<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ì²­ì†Œë…„ ë§ˆìŒë„ì›€</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- CSV íŒŒì„œ (ë¸Œë¼ìš°ì €ì—ì„œ ë°”ë¡œ CSV ì½ê¸°) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    .bubble{border-radius:12px;padding:10px 12px;margin:6px 0;max-width:80%;}
    .me{background:#e8f0ff;align-self:flex-end;}
    .bot{background:#f5f5f5;align-self:flex-start;}
    .phq-card{border:1px solid #ddd;border-radius:12px;padding:12px;margin:10px 0;background:#fff;}
    .chat-area{display:flex;flex-direction:column;height:520px;overflow-y:auto;background:white;padding:12px;border:1px solid #e5e7eb;border-radius:10px;}
    a.link{color:#1d4ed8;text-decoration:underline;}
  </style>
</head>
<body class="bg-gray-50">
  <div class="max-w-6xl mx-auto p-4">
    <h1 class="text-2xl font-bold mb-1">ì²­ì†Œë…„ ë§ˆìŒë„ì›€</h1>
    <p class="text-sm text-gray-600 mb-4">
      ì´ ì„œë¹„ìŠ¤ëŠ” <b>ì„ ë³„(Screening)</b>ê³¼ <b>ì—°ê²°</b>ì„ ë•ê¸° ìœ„í•œ ë„êµ¬ì…ë‹ˆë‹¤. ì§„ë‹¨ì´ë‚˜ ì¹˜ë£Œê°€ ì•„ë‹™ë‹ˆë‹¤.
    </p>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-2">
      <!-- ì¢Œ: PHQ-9 -->
      <div>
        <div class="phq-card">
          <div class="flex justify-between items-center">
            <h2 class="font-semibold text-lg">PHQ-9 ìš°ìš¸ ìê°€ê²€ì‚¬</h2>
            <button id="startBtn" class="px-3 py-1 bg-blue-600 text-white rounded">ê²€ì‚¬ ì‹œì‘</button>
          </div>

          <div id="phqPanel" class="mt-3 hidden">
            <div id="qBox" class="mb-3 text-sm"></div>
            <div class="flex gap-2">
              <button id="prevBtn" class="px-3 py-1 bg-gray-200 rounded">ì´ì „</button>
              <button id="nextBtn" class="px-3 py-1 bg-blue-600 text-white rounded">ë‹¤ìŒ</button>
            </div>
          </div>

          <div id="resultBox" class="mt-4 text-sm"></div>
          <div id="centersBox" class="mt-4 text-sm"></div>
        </div>
      </div>

      <!-- ìš°: ëŒ€í™”í˜• ì§€ì›(í•­ìƒ ì‹œì—° ëª¨ë“œ) -->
      <div>
        <div class="phq-card flex flex-col">
          <h2 class="font-semibold text-lg mb-2">ëŒ€í™”í˜• ì§€ì›</h2>
          <div id="chatArea" class="chat-area">
            <div class="bubble bot">
              ì•ˆë…•, ì—¬ê¸´ ë§ˆìŒë„ì›€ ì±—ì´ì•¼. í˜ë“  ë§ˆìŒì„ ë“¤ë ¤ì¤˜ë„ ê´œì°®ì•„.<br/>
              ìœ„ê¸°ë¼ë©´ <b>1577-0199 ë˜ëŠ” 119</b>ì— ì§€ê¸ˆ ë°”ë¡œ ì—°ë½í•´ì¤˜.
            </div>
          </div>
          <div class="mt-2 flex gap-2">
            <input id="chatInput" class="flex-1 border rounded px-2 py-2" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
            <button id="sendBtn" class="px-3 py-2 bg-blue-600 text-white rounded">ì „ì†¡</button>
          </div>
        </div>
      </div>
    </div>

    <p class="text-xs text-gray-500 mt-6">
      â€» ì‘ë‹µ ë‚´ìš©ì€ ì €ì¥ë˜ì§€ ì•Šìœ¼ë©°, ì´ ë„êµ¬ëŠ” êµìœ¡ìš©/ì‹œì—°ìš© í”„ë¡œí† íƒ€ì…ì…ë‹ˆë‹¤. ìœ„ê¸° ì‹œ ì¦‰ì‹œ <b>1577-0199 ë˜ëŠ” 119</b>ë¡œ ì—°ë½í•˜ì„¸ìš”.
    </p>
  </div>

  <script>
    /* ======================== ê³µí†µ ======================== */
    function pushBubble(text, who='bot'){
      const chatArea=document.getElementById('chatArea');
      const div=document.createElement('div');
      div.className=`bubble ${who}`;
      div.innerHTML=(''+text).replace(/\n/g,'<br/>');
      chatArea.appendChild(div);
      chatArea.scrollTop=chatArea.scrollHeight;
    }

    /* ======================== ì±—ë´‡ (ì‹œì—° ê³ ì •) ======================== */
    const SCRIPT=[
      "ì•ˆë…•, ì—¬ê¸´ ë§ˆìŒë„ì›€ ì±—ì´ì•¼. ì˜¤ëŠ˜ í•˜ë£¨ ì–´ë• ì–´?",
      "ìŒ, ì‰½ì§€ ì•Šì•˜ê² ë‹¤. ì´ë ‡ê²Œ ë§í•´ì¤˜ì„œ ì •ë§ ê³ ë§ˆì›Œ.",
      "ìš”ì¦˜ ê°€ì¥ í˜ë“¤ì—ˆë˜ ìˆœê°„ì´ ì–¸ì œì˜€ëŠ”ì§€ í•˜ë‚˜ë§Œ ë– ì˜¬ë ¤ë³¼ë˜?",
      "ê·¸ë•Œ ë„ˆì˜ ëª¸ì´ë‚˜ ë§ˆìŒì—ì„œ ì–´ë–¤ ì‹ í˜¸ê°€ ìˆì—ˆëŠ”ì§€ë„ ê°™ì´ ì ì–´ë³´ì.",
      "ì ê¹, í˜¸í¡ì„ ê°™ì´ ë§ì¶°ë³¼ê¹Œ? 4ì´ˆ ë“¤ì´ë§ˆì‹œê³ , 4ì´ˆ ë©ˆì¶”ê³ , 6ì´ˆ ë‚´ì‰¬ê¸° Ã— 3íšŒ.",
      "ë§Œì•½ ë§ˆìŒì´ ë„ˆë¬´ ë²…ì°¨ë©´ ë°”ë¡œ ë„ì›€ì„ ë°›ëŠ” ê²Œ ì¤‘ìš”í•´. 1577-0199(ì •ì‹ ê±´ê°• ìƒë‹´ì „í™”) ë˜ëŠ” 119ë¥¼ ê¸°ì–µí•´ì¤˜.",
      "ê°€ê¹Œìš´ ìƒë‹´ì„¼í„°ë‚˜ ë³´ê±´ì†Œì— ì—°ê²°í•˜ë©´ ë” ì²´ê³„ì ìœ¼ë¡œ ë„ìš¸ ìˆ˜ ìˆì–´.",
      "ì˜¤ëŠ˜ ë„ˆë¥¼ ë²„í‹°ê²Œ í•´ì¤€ ì‘ì€ ê²ƒ í•˜ë‚˜ë§Œ ì ì–´ë³¼ë˜? (ì‚¬ëŒ, ìŒì•…, ì¥ì†Œ, ë£¨í‹´ ë¬´ì—‡ì´ë“  ì¢‹ì•„)",
      "ì•ìœ¼ë¡œ 24ì‹œê°„ ë™ì•ˆ ìŠ¤ìŠ¤ë¡œì—ê²Œ í•´ì¤„ ìˆ˜ ìˆëŠ” ì•„ì£¼ ì‘ì€ í–‰ë™ í•˜ë‚˜ë¥¼ ì •í•´ë³´ì. (ë¬¼ í•œ ì»µ, 10ë¶„ ì‚°ì±… ê°™ì€ ê²ƒ)",
      "ë„¤ê°€ í˜¼ìê°€ ì•„ë‹ˆë¼ëŠ” ê±¸ ê¼­ ê¸°ì–µí•´ì¤˜. í•„ìš”í•˜ë©´ ì–¸ì œë“  ë‹¤ì‹œ ë§ ê±¸ì–´ì¤˜.",
      "ì´ ëŒ€í™”ëŠ” ì„ ë³„/ì§€ì§€ ëª©ì ì´ì•¼. ì§„ë‹¨ì´ë‚˜ ì¹˜ë£Œê°€ í•„ìš”í•˜ë©´ ì „ë¬¸ê°€ì™€ ê¼­ ìƒì˜í•˜ì.",
      "(ë‹¤ì‹œ ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°ˆê²Œ!) ìš”ì¦˜ ê°€ì¥ í˜ë“¤ì—ˆë˜ ìˆœê°„ì´ ì–¸ì œì˜€ëŠ”ì§€ í•˜ë‚˜ë§Œ ë– ì˜¬ë ¤ë³¼ë˜?"
    ];
    let scriptIdx=0;

    const sendBtn=document.getElementById('sendBtn');
    const chatInput=document.getElementById('chatInput');

    sendBtn.onclick=()=>{
      const msg=chatInput.value.trim();
      if(!msg) return;
      pushBubble(msg,'me');
      chatInput.value='';
      const line=SCRIPT[scriptIdx]||"(ë)";
      pushBubble(line,'bot');
      scriptIdx=(scriptIdx+1)%SCRIPT.length;
    };
    chatInput.addEventListener('keydown',e=>{if(e.key==='Enter')sendBtn.click();});

    /* ======================== PHQ-9 (í´ë¼ì´ì–¸íŠ¸ í•´ì„) ======================== */
    const PHQ=[
      "ì¼(ê³µë¶€)ì— í¥ë¯¸ë‚˜ ì¦ê±°ì›€ì´ ê±°ì˜ ì—†ë‹¤",
      "ê¸°ë¶„ì´ ê°€ë¼ì•‰ê±°ë‚˜, ìš°ìš¸í•˜ê±°ë‚˜, í¬ë§ì´ ì—†ë‹¤",
      "ì ë“¤ê¸° ì–´ë µê±°ë‚˜ ìì£¼ ê¹¨ê±°ë‚˜ ë„ˆë¬´ ë§ì´ ì”ë‹¤",
      "í”¼ê³¤í•˜ë‹¤ê³  ëŠë¼ê±°ë‚˜ ê¸°ìš´ì´ ê±°ì˜ ì—†ë‹¤",
      "ì…ë§›ì´ ì—†ê±°ë‚˜ ê³¼ì‹í•œë‹¤",
      "ìì‹ ì„ ë‚˜ì˜ê²Œ ë³´ê±°ë‚˜ ì‹¤íŒ¨ìë¼ê³  ëŠë‚€ë‹¤",
      "ì¼(ê³µë¶€)ì— ì§‘ì¤‘í•˜ê¸°ê°€ ì–´ë µë‹¤",
      "ë‚¨ë“¤ì´ ì•Œì•„ì±Œ ë§Œí¼ ë„ˆë¬´ ëŠë¦¬ê²Œ ì›€ì§ì´ê±°ë‚˜ ë§í•œë‹¤, í˜¹ì€ ë„ˆë¬´ ì´ˆì¡°í•´ì„œ ê°€ë§Œíˆ ìˆì§€ ëª»í•œë‹¤",
      "ì°¨ë¼ë¦¬ ì£½ëŠ” ê²ƒì´ ë‚«ê² ë‹¤ëŠ” ìƒê°ì„ í•˜ê±°ë‚˜, ìì‹ ì„ í•´ì¹  ìƒê°ì„ í–ˆë‹¤"
    ];
    const CHOICES=["ì „í˜€ ì•„ë‹ˆë‹¤(0)","ëª‡ ì¼ ë™ì•ˆ(1)","ì¼ì£¼ì¼ ì´ìƒ(2)","ê±°ì˜ ë§¤ì¼(3)"];

    let idx=0, answers=Array(9).fill(null), userLat=null, userLng=null;

    const startBtn=document.getElementById('startBtn');
    const phqPanel=document.getElementById('phqPanel');
    const qBox=document.getElementById('qBox');
    const prevBtn=document.getElementById('prevBtn');
    const nextBtn=document.getElementById('nextBtn');
    const resultBox=document.getElementById('resultBox');
    const centersBox=document.getElementById('centersBox');

    // CSV ë©”ëª¨ë¦¬
    let CENTER_ROWS = []; // {name,address,phone,lat,lng}

    // CSV ë¡œë“œ (public/data/centers.csv)
    async function loadCentersCsv(){
      try{
        const res = await fetch('/data/centers.csv', {cache:'no-store'});
        if(!res.ok) return [];
        const text = await res.text();
        return new Promise((resolve)=>{
          Papa.parse(text, {
            header:true,
            skipEmptyLines:true,
            dynamicTyping:true,
            complete: (out)=>{
              // ë§¤í•‘: ë‹¤ì–‘í•œ í•œê¸€/ì˜ë¬¸ í—¤ë”ë¥¼ ê³µí†µí‚¤ë¡œ ë³€í™˜
              const norm = (k)=> (k||"").toString().trim().toLowerCase();
              const rows = out.data.map(row=>{
                // ì›ë³¸ í—¤ë”ë¥¼ ì†Œë¬¸ì ë¹„êµ
                const mapKey = {};
                for(const k in row){ mapKey[norm(k)] = k; }

                const name = row[ mapKey["ê¸°ê´€ëª…"] || mapKey["name"] ] || "";
                const address = row[ mapKey["ì£¼ì†Œ"] || mapKey["address"] ] || "";
                const phone = row[ mapKey["ì „í™”ë²ˆí˜¸"] || mapKey["phone"] ] || "";
                const lat = Number(row[ mapKey["ìœ„ë„"] || mapKey["lat"] || mapKey["latitude"] ]);
                const lng = Number(row[ mapKey["ê²½ë„"] || mapKey["lng"] || mapKey["longitude"] ]);

                return { name: String(name||"").trim(),
                         address: String(address||"").trim(),
                         phone: String(phone||"").trim(),
                         lat: isFinite(lat)? lat: NaN,
                         lng: isFinite(lng)? lng: NaN };
              }).filter(r=>r.name || r.address);
              resolve(rows);
            }
          });
        });
      }catch{
        return [];
      }
    }

    function haversine(lat1, lon1, lat2, lon2){
      const toRad = (d)=> d*Math.PI/180;
      const R = 6371; // km
      const dLat = toRad(lat2-lat1);
      const dLon = toRad(lon2-lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(a));
    }

    function severityLabel(total){
      if(total<=4) return "ì—†ìŒ/ìµœì†Œ";
      if(total<=9) return "ê²½ë„";
      if(total<=14) return "ì¤‘ë“±ë„";
      if(total<=19) return "ì¤‘ë“±ë„-ì¤‘ì¦";
      return "ì¤‘ì¦";
    }

    function supportiveText(total, sev, crisis){
      if(crisis){
        return "[ê³ ìœ„í—˜] ì§€ê¸ˆ ë§¤ìš° ìœ„ê¸‰í•  ìˆ˜ ìˆì–´ìš”. ì¦‰ì‹œ 1577-0199 ë˜ëŠ” 119ì— ì—°ë½í•˜ì„¸ìš”.";
      }
      if(sev==="ì—†ìŒ/ìµœì†Œ") return "í˜„ì¬ ì ìˆ˜ëŠ” ë‚®ì€ í¸ì´ì—ìš”. ê·¸ë˜ë„ í˜ë“¤ë©´ ì£¼ë³€ì˜ ë¯¿ì„ ë§Œí•œ ì–´ë¥¸ì´ë‚˜ ì¹œêµ¬ì™€ ì´ì•¼ê¸°ë¥¼ ë‚˜ëˆ  ë³´ì„¸ìš”.";
      if(sev==="ê²½ë„") return "ê°€ë²¼ìš´ ìš°ìš¸ê°ì´ ê°ì§€ë¼ìš”. ì , ì‹ì‚¬, ê°€ë²¼ìš´ ìš´ë™ ê°™ì€ ì¼ìƒ ë¦¬ë“¬ì„ ì±™ê²¨ ë³´ì„¸ìš”.";
      if(sev==="ì¤‘ë“±ë„") return "ì¤‘ë“±ë„ ìˆ˜ì¤€ì˜ ìš°ìš¸ê°ì´ ë³´ì—¬ìš”. í•™êµ ìƒë‹´ì‹¤, ì§€ì—­ ì •ì‹ ê±´ê°•ë³µì§€ì„¼í„° ìƒë‹´ì„ ê¶Œí•´ìš”.";
      if(sev==="ì¤‘ë“±ë„-ì¤‘ì¦") return "ìš°ìš¸ê°ì´ ëšœë ·í•©ë‹ˆë‹¤. ê°€ê¹Œìš´ ìƒë‹´ê¸°ê´€ì— ë¹ ë¥´ê²Œ ì—°ê²°í•˜ëŠ” ê²ƒì„ ê¶Œí•´ìš”.";
      return "ì ìˆ˜ê°€ ë†’ì€ í¸ì´ì—ìš”. ê°€ëŠ¥í•œ ë¹ ë¥´ê²Œ ì „ë¬¸ ìƒë‹´/ì§„ë£Œë¥¼ ë°›ì•„ ë³´ì„¸ìš”.";
    }

    async function recommendCenters(lat, lng, topN=6){
      if(!CENTER_ROWS.length){
        CENTER_ROWS = await loadCentersCsv();
      }
      let arr = CENTER_ROWS.filter(r=> isFinite(r.lat) && isFinite(r.lng));
      if(!arr.length){
        return `<li>ì„¼í„° ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ì¢Œí‘œê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ ì£¼ì„¸ìš”.</li>`;
      }
      if(isFinite(lat) && isFinite(lng)){
        arr = arr.map(r=> ({...r, d: haversine(lat,lng,r.lat,r.lng)}))
                 .sort((a,b)=>(a.d||1e9)-(b.d||1e9));
      }
      const sel = arr.slice(0, topN);
      return sel.map(c=>{
        const q = encodeURIComponent(c.address || c.name);
        const km = isFinite(c.d) ? ` â€¢ ì•½ ${c.d.toFixed(1)} km` : "";
        const tel = c.phone ? ` | ğŸ“ ${c.phone}` : "";
        return `<li class="mb-2">
          <div><b>${c.name || "(ê¸°ê´€ëª… ì—†ìŒ)"}</b>${km}</div>
          <div>${c.address || ""}${tel}</div>
          <div><a class="link" target="_blank" href="https://map.kakao.com/?q=${q}">ì§€ë„ ì—´ê¸°</a></div>
        </li>`;
      }).join("");
    }

    startBtn.onclick=async ()=>{
      idx=0; answers=Array(9).fill(null);
      phqPanel.classList.remove('hidden');
      resultBox.innerHTML=''; centersBox.innerHTML='';
      CENTER_ROWS = await loadCentersCsv(); // ë¯¸ë¦¬ ë¡œë“œ
      renderQ();

      // ìœ„ì¹˜ ê¶Œí•œ (ê±°ë¶€í•´ë„ ë™ì‘: ê±°ë¦¬ ì •ë ¬ ì—†ì´ ìƒìœ„ ë¦¬ìŠ¤íŠ¸ë§Œ)
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(
          (p)=>{ userLat=p.coords.latitude; userLng=p.coords.longitude; },
          ()=>{}, { enableHighAccuracy:false, timeout:5000, maximumAge:0 }
        );
      }
    };

    function renderQ(){
      const a=answers[idx];
      qBox.innerHTML=`
        <div class="mb-2"><b>${idx+1}. ${PHQ[idx]}</b></div>
        <div class="space-y-1">
          ${CHOICES.map((t,i)=>`
            <label class="flex items-center gap-2">
              <input type="radio" name="ans" value="${i}" ${a===i?'checked':''}/>
              <span>${t}</span>
            </label>`).join('')}
        </div>`;
    }
    prevBtn.onclick=()=>{ if(idx>0){ idx--; renderQ(); } };
    nextBtn.onclick=async ()=>{
      const sel=document.querySelector('input[name="ans"]:checked');
      if(!sel){ alert('í•˜ë‚˜ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”'); return; }
      answers[idx]=Number(sel.value);
      if(idx<8){ idx++; renderQ(); return; }

      // ë¡œì»¬ í•´ì„ + ê·¼ì²˜ ì„¼í„° ì¶”ì²œ
      phqPanel.classList.add('hidden');
      const total=answers.reduce((a,b)=>a+(Number(b)||0),0);
      const sev=severityLabel(total);
      const crisis=(Number(answers[8])||0) >= 1;

      const sup=supportiveText(total, sev, crisis);
      const crisisHtml = crisis
        ? `<div class="text-red-600 font-semibold mb-2">${sup}</div>`
        : `<div class="mb-2">${sup}</div>`;

      resultBox.innerHTML = `
        ${crisisHtml}
        <div>ì´ì : <b>${total}</b> / ì¤‘ì¦ë„: <b>${sev}</b></div>
        <div class="text-xs text-gray-600 mt-2">ì´ ë„êµ¬ëŠ” ì„ ë³„ìš©ì´ë©° ì§„ë‹¨/ì¹˜ë£Œê°€ ì•„ë‹™ë‹ˆë‹¤.</div>
      `;

      centersBox.innerHTML = `<div class="text-gray-500">ê°€ê¹Œìš´ ì„¼í„°ë¥¼ ì°¾ëŠ” ì¤‘...</div>`;
      const listHtml = await recommendCenters(userLat, userLng, 8);
      centersBox.innerHTML = `
        <h3 class="font-semibold mt-4 mb-2">ê°€ê¹Œìš´ ìƒë‹´ ë„ì›€</h3>
        <ul>${listHtml}</ul>
        <div class="mt-2 text-sm">ë˜ëŠ” ì¦‰ì‹œ <b>1577-0199</b> (ì •ì‹ ê±´ê°•ìƒë‹´ì „í™”)ì— ì—°ë½í•˜ì„¸ìš”.</div>
      `;
    };
  </script>
</body>
</html>
